<?php 
$username = "";
$email = "";
$db = mysqli_connect('localhost', 'root', '', 'malware_detection');
$errors = array();

// logout
if (isset($_GET['logout'])) {
    session_destroy();
    unset($_SESSION['username']);
}

// update
if(isset($_POST['update']))
{
    $email = $_POST['email'];
    $password_1 = $_POST['password_1'];
    $password_2 = $_POST['password_2'];
    
    $regexEmail = '/[a-zA-Z_\-]+@(([a-zA-Z_\-])+\.)+[a-zA-Z]{2,4}/';
    
    if (empty($email)) {
        array_push($errors, "Email is required");
    } else if (preg_match($regexEmail, $email)) {
    } else {
        array_push($errors, "Invalid email");
    }
    
    if (empty($password_1)) {
        array_push($errors, "Password is required");
    }
    
    if ($password_1 != $password_2) {
        array_push($errors, "The two passwords do not match");
    }
    
    if (count($errors) == 0) {
        $username = $_SESSION['username'];
        $password = password_hash($password_1, PASSWORD_DEFAULT);
        $sql = "UPDATE user SET email=?, password=? where username=?";
        $stmt = mysqli_stmt_init($db);
        if (!mysqli_stmt_prepare($stmt, $sql)) {
            echo "SQL statement failure!";
        } else {
            mysqli_stmt_bind_param($stmt, "sss", $email, $password, $username);
            mysqli_stmt_execute($stmt);
            echo "<script> alert('Profile successfully updated!'); 
                window.location = 'index.php'</script>";
        }
    }
}

// delete
if(isset($_POST['delete']))
{
    $username = $_SESSION['username'];
    $sql = "DELETE FROM user where username=?";
    $stmt = mysqli_stmt_init($db);
    if (!mysqli_stmt_prepare($stmt, $sql)) {
        echo "SQL statement failure!";
    } else {
        mysqli_stmt_bind_param($stmt, "s", $username);
        mysqli_stmt_execute($stmt);
        session_destroy();
        unset($_SESSION['username']);
        echo "<script> alert('Profile successfully deleted!'); </script>";
    }

}
?>