<?php
    session_start();
    session_regenerate_id();
    $username = "";
    $email = "";
    $errors = array();
    
    // connect to database
    $db = mysqli_connect('localhost', 'root', '', 'malware_detection');
    
    // register
    if (isset($_POST['register'])) {
        $username = htmlspecialchars(mysqli_real_escape_string($db, $_POST['username']));
        $email = htmlspecialchars(mysqli_real_escape_string($db, $_POST['email']));
        $password_1 = htmlspecialchars(mysqli_real_escape_string($db, $_POST['password_1']));
        $password_2 = htmlspecialchars(mysqli_real_escape_string($db, $_POST['password_2']));

        $regexEmail = '/[a-zA-Z_\-]+@(([a-zA-Z_\-])+\.)+[a-zA-Z]{2,4}/';
        $regexName = "^[a-zA-Z]+(([',. -][a-zA-Z ])?[a-zA-Z]*)*$^";
        
        $sql_username = "SELECT * FROM user WHERE username='$username'";  
        $sql_email = "SELECT * FROM user WHERE email='$email'";
        $res_username = mysqli_query($db, $sql_username) or die(mysqli_error($db));
        $res_email = mysqli_query($db, $sql_email) or die(mysqli_error($db));
        
        // ensure that fields are filled properly
        if (empty($username)) {
            array_push($errors, "Username is required");
        } else if (preg_match($regexName, $username)) {
        } else {
            array_push($errors, "Invalid Username. It must only contain letters and spaces.");
        }
        
        if (empty($email)) {
            array_push($errors, "Email is required");
        } else if (preg_match($regexEmail, $email)) {
        } else {
            array_push($errors, "Invalid email");
        }
        
        if (empty($password_1)) {
            array_push($errors, "Password is required");
        }
        
        if ($password_1 != $password_2) {
            array_push($errors, "The two passwords do not match");
        }
        
        if (mysqli_num_rows($res_username) > 0) {
            array_push($errors, "Username has already been taken");
        }
        
        if (mysqli_num_rows($res_email) > 0) {
            array_push($errors, "Email has already been taken");
        }
        
        // if no errors in array, proceed to insert into database
        if (count($errors) == 0) {
            $password = password_hash($password_1, PASSWORD_DEFAULT);
            $sql = "INSERT INTO user (username, email, password) VALUES (?, ?, ?)";
            $stmt = mysqli_stmt_init($db);
            if (!mysqli_stmt_prepare($stmt, $sql)) {
                echo "SQL statement failure!";
            } else {
                mysqli_stmt_bind_param($stmt, "sss", $username, $email, $password);
                mysqli_stmt_execute($stmt);
                $_SESSION['username'] = $username;
                echo "<script> alert('Account successfully registered!');window.location='login.php' </script>";
            }
        }
    }
    
    
    // login
    if (isset($_POST['login'])) 
    {
        $username = $_POST['username'];
        $password = $_POST['password'];
        $type= $_POST['type'];
        
        $dbpassword = null;
        
        $query = $db->prepare("SELECT password FROM user WHERE username=?");
        $query->bind_param('s', $username);
        $query->execute();
        $query->bind_result($dbpassword);
        while ($query->fetch()) {
            $dbpassword = $dbpassword;
        }
        
        if (empty($username)) {
            array_push($errors, "Username is required");
        }
        if (empty($password)) {
            array_push($errors, "Password is required");
        }
        
        if (count($errors) == 0) 
        {
            $verify = password_verify($password, $dbpassword);
            if ($verify == 1) 
            {   
                $query1 = "SELECT * FROM user WHERE username= ? AND password= ?";
                $stmt = mysqli_stmt_init($db);
                if (! mysqli_stmt_prepare($stmt, $query1)) {
                    echo "SQL statement failure!";
                } else {
                    mysqli_stmt_bind_param($stmt, "ss", $username, $dbpassword);
                    mysqli_stmt_execute($stmt);
                    $result = mysqli_stmt_get_result($stmt);
                }
                $row = $result->fetch_assoc();
                $type = $row['type'];
                
                $_SESSION['username'] = $username;
                $_SESSION['timeout'] = time();
                if ($type == 'Admin'){
                    header("Location: adminindex.php");
                } else {
                    header("Location: index.php");
                }
            }
            else {
                array_push($errors, "Incorrect Username or Password");
            }
        }
    }
?>